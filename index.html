<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>åˆ†å¸³å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-y: auto;
    }

    .container {
      max-width: 850px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .people-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .person-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .person-number {
      width: 32px;
      height: 32px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }

    .person-input input {
      flex: 1;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    /* ç°è‰²æŒ‰éˆ•æ¨£å¼ (ç”¨æ–¼é—œé–‰æŒ‰éˆ•) */
    .btn-gray {
      background: #718096;
      color: white;
      box-shadow: 0 4px 15px rgba(113, 128, 150, 0.4);
    }
    .btn-gray:hover {
      background: #4a5568;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #e9ecef;
      color: #495057;
    }

    .btn-secondary:hover {
      background: #dee2e6;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .bill-item {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .bill-item:hover {
      border-color: #cbd5e0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .bill-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .bill-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
    }

    .bill-amount {
      font-size: 18px;
      font-weight: 700;
      color: #667eea;
    }

    .bill-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .bill-detail-item {
      font-size: 13px;
      color: #718096;
    }

    .bill-detail-label {
      font-weight: 600;
      color: #4a5568;
    }

    .participant-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .participant-tag {
      background: #edf2f7;
      color: #4a5568;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .category-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2fe;
      color: #0369a1;
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 12px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .checkbox-label:hover {
      background: #f7fafc;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .result-section {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      padding: 25px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .settlement-item {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .settlement-text {
      font-size: 15px;
      color: #2d3748;
    }

    .settlement-from {
      font-weight: 700;
      color: #667eea;
    }

    .settlement-to {
      font-weight: 700;
      color: #764ba2;
    }

    .settlement-amount {
      font-size: 20px;
      font-weight: 700;
      color: #48bb78;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .hidden {
      display: none;
    }

    .error-message {
      background: #fed7d7;
      color: #c53030;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
    }

    .helper-text {
      font-size: 12px;
      color: #718096;
      margin-top: 6px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 50;
    }

    .modal {
      background: white;
      border-radius: 14px;
      padding: 20px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
    }

    .modal h3 {
      margin-bottom: 10px;
      font-size: 18px;
      color: #2d3748;
    }

    .modal p {
      color: #4a5568;
      font-size: 14px;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ç¢ºä¿å½ˆçª—éš±è—æ™‚ä¸é¡¯ç¤º */
    .modal-overlay.hidden {
      display: none;
    }

    .detail-section {
      background: #f8fafc;
      border: 2px dashed #cbd5e0;
    }

    .detail-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 700;
      color: #2d3748;
    }

    .detail-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      font-size: 13px;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .detail-participants {
      font-size: 13px;
      color: #4a5568;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’° åˆ†å¸³å™¨</h1>
      <p>è¼•é¬†ç®¡ç†åœ˜é«”å¸³å‹™ï¼Œä¸€éµè¨ˆç®—èª°è©²ä»˜èª°å¤šå°‘éŒ¢</p>
    </div>

    <div class="content">
      <div class="section">
        <div class="section-title">
          <span class="step-number">1</span>
          è¨­å®šåƒèˆ‡äººå“¡
        </div>
        <div class="form-group">
          <label>åƒèˆ‡äººæ•¸ï¼ˆæœ€å¤š 20 äººï¼‰</label>
          <input type="number" id="peopleCount" min="2" max="20" value="3" />
        </div>
        <div class="form-group">
          <label>é è¨­å¹£åˆ¥</label>
          <select id="baseCurrency"></select>
          <div id="rateInfo" class="helper-text">è¨ˆç®—æ™‚ç”±å¾Œç«¯è‡ªå‹•æŠ“å–åŒ¯ç‡</div>
        </div>
        <div id="peopleInputs" class="people-grid"></div>
        <div class="button-group">
          <button class="btn-primary" id="confirmPeople">
            âœ“ ç¢ºèªäººå“¡
          </button>
        </div>
      </div>

      <div class="section hidden" id="billSection">
        <div class="section-title">
          <span class="step-number">2</span>
          æ–°å¢å¸³å–®
        </div>

        <div class="form-group">
          <label>å¸³å–®åç¨±</label>
          <input type="text" id="billTitle" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Šã€é›»å½±ç¥¨" />
        </div>

        <div class="form-group">
          <label>åˆ†é¡ï¼ˆå¯é¸ï¼‰</label>
          <select id="billCategory">
            <option value="">ç„¡åˆ†é¡</option>
            <option value="äº¤é€š">äº¤é€š</option>
            <option value="é£²é£Ÿ">é£²é£Ÿ</option>
            <option value="ä½å®¿">ä½å®¿</option>
            <option value="å¨›æ¨‚">å¨›æ¨‚</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label>å¹£åˆ¥</label>
          <select id="billCurrency"></select>
        </div>

        <div class="form-group">
          <label>é‡‘é¡</label>
          <input type="number" id="billAmount" step="0.01" min="0" placeholder="0.00" />
        </div>

        <div class="form-group">
          <label>ç”±èª°å…ˆä»˜æ¬¾</label>
          <select id="billPaidBy"></select>
        </div>

        <div class="form-group">
          <label>åƒèˆ‡åˆ†å¸³çš„äººï¼ˆå¯å¤šé¸ï¼‰</label>
          <div id="billParticipants" class="checkbox-group"></div>
        </div>

        <div class="button-group">
          <button class="btn-success" id="addBill">
            â• æ–°å¢æ­¤å¸³å–®
          </button>
        </div>

        <div id="billError" class="error-message hidden"></div>

        <div id="billsList" style="margin-top: 30px;"></div>

        <div class="button-group" id="calculateSection" style="display: none;">
          <button class="btn-primary" id="calculateBtn">
            ğŸ§® åˆ†å¸³çµæœ
          </button>
        </div>
      </div>

      <div class="section hidden" id="resultSection">
        <div class="section-title">
          <span class="step-number">3</span>
          çµç®—çµæœ
        </div>
        <div id="resultContent"></div>
      </div>

      <div class="section hidden detail-section" id="detailSection">
        <div class="section-title">
          <span class="step-number">4</span>
          æŸ¥çœ‹æ˜ç´°
        </div>
        <div class="helper-text" style="margin-bottom: 12px;">é¡¯ç¤ºæ¯ç­†æ”¯å‡ºåŸå¹£ã€æ›ç®—é‡‘é¡èˆ‡åˆ†æ”¤ç´°ç¯€</div>
        <div id="detailContent"></div>
        <div class="button-group" style="justify-content: flex-end;">
          <button class="btn-secondary" id="resetBtn">
            ğŸ”„ é‡æ–°é–‹å§‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay hidden" id="resetModal">
    <div class="modal">
      <h3>é‡æ–°é–‹å§‹</h3>
      <p>ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿç›®å‰å¡«å¯«çš„è³‡æ–™éƒ½æœƒæ¸…é™¤ã€‚</p>
      <div class="modal-actions">
        <button class="btn-secondary" id="cancelResetBtn">å–æ¶ˆ</button>
        <button class="btn-danger" id="confirmResetBtn">ç¢ºèªæ¸…é™¤</button>
      </div>
    </div>
  </div>

  <script>
    const MAX_PEOPLE = 20;
    const CURRENCIES = [
      { code: 'TWD', label: 'æ–°å°å¹£ (TWD)' },
      { code: 'USD', label: 'ç¾é‡‘ (USD)' },
      { code: 'EUR', label: 'æ­å…ƒ (EUR)' },
      { code: 'JPY', label: 'æ—¥åœ“ (JPY)' },
      { code: 'KRW', label: 'éŸ“å…ƒ (KRW)' },
      { code: 'HKD', label: 'æ¸¯å¹£ (HKD)' },
      { code: 'CNY', label: 'äººæ°‘å¹£ (CNY)' },
    ];

    // ç‹€æ…‹è®Šæ•¸
    let baseCurrency = 'TWD';
    let lastBillCurrency = baseCurrency;
    let people = [];
    let bills = [];
    let billIdCounter = 1;
    let lastServerUpdate = 0; 
    
    // â˜…â˜…â˜… æ–°å¢ç‹€æ…‹ï¼šæ˜¯å¦é¡¯ç¤ºçµæœ â˜…â˜…â˜…
    let isResultVisible = false;

    // DOM å…ƒç´ 
    const peopleCountInput = document.getElementById('peopleCount');
    const peopleInputsDiv = document.getElementById('peopleInputs');
    const confirmPeopleBtn = document.getElementById('confirmPeople');
    const billSection = document.getElementById('billSection');
    const billTitleInput = document.getElementById('billTitle');
    const billCategorySelect = document.getElementById('billCategory');
    const baseCurrencySelect = document.getElementById('baseCurrency');
    const billCurrencySelect = document.getElementById('billCurrency');
    const rateInfo = document.getElementById('rateInfo');
    const billAmountInput = document.getElementById('billAmount');
    const billPaidBySelect = document.getElementById('billPaidBy');
    const billParticipantsDiv = document.getElementById('billParticipants');
    const addBillBtn = document.getElementById('addBill');
    const billsListDiv = document.getElementById('billsList');
    const calculateSection = document.getElementById('calculateSection');
    const calculateBtn = document.getElementById('calculateBtn');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const resetBtn = document.getElementById('resetBtn');
    const billError = document.getElementById('billError');
    const resetModal = document.getElementById('resetModal');
    const cancelResetBtn = document.getElementById('cancelResetBtn');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    let detailSectionEl = document.getElementById('detailSection');
    let detailContentEl = document.getElementById('detailContent');

    // åˆå§‹åŒ–
    populateCurrencySelect(baseCurrencySelect, baseCurrency);
    populateCurrencySelect(billCurrencySelect, lastBillCurrency);
    generatePeopleInputs();

    // å•Ÿå‹•æ™‚å˜—è©¦å¾ä¼ºæœå™¨åŒæ­¥è³‡æ–™
    syncFromServer();
    // è¨­å®šå®šæ™‚å™¨ï¼Œæ¯ 2 ç§’è‡ªå‹•åŒæ­¥ä¸€æ¬¡
    setInterval(syncFromServer, 2000);

    // ================== åŒæ­¥æ ¸å¿ƒåŠŸèƒ½ ==================

    async function syncFromServer() {
      if (window.calculateSplit) return;

      try {
        const response = await fetch('/api/sync');
        if (!response.ok) return;

        const state = await response.json();

        if (state.lastUpdated > lastServerUpdate || (state.people.length > 0 && people.length === 0)) {
          lastServerUpdate = state.lastUpdated;

          people = state.people || [];
          bills = state.bills || [];
          baseCurrency = state.baseCurrency || 'TWD';

          if (bills.length > 0) {
            const maxId = Math.max(...bills.map(b => b.id));
            billIdCounter = maxId + 1;
          }

          if (people.length > 0) {
            updateUIForExistingProject();
            if (bills.length > 0) {
              calculate();
            }
          } else {
            resetUI();
          }
        }
      } catch (e) {
        console.log("åŒæ­¥ç•¥éï¼šç„¡æ³•é€£æ¥ä¼ºæœå™¨");
      }
    }

    async function pushToServer() {
      if (window.calculateSplit) return; 

      const state = {
        people: people,
        bills: bills,
        baseCurrency: baseCurrency
      };

      try {
        await fetch('/api/sync', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(state)
        });
        syncFromServer();
      } catch (e) {
        alert("ç„¡æ³•å„²å­˜è‡³ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥é€£ç·š");
      }
    }

    function updateUIForExistingProject() {
      peopleCountInput.disabled = true;
      confirmPeopleBtn.disabled = true;
      confirmPeopleBtn.innerText = "âœ“ äººå“¡å·²è¨­å®š";

      billPaidBySelect.innerHTML = '';
      people.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name;
        billPaidBySelect.appendChild(option);
      });

      if (billParticipantsDiv.children.length !== people.length) {
        billParticipantsDiv.innerHTML = '';
        people.forEach(person => {
          const label = document.createElement('label');
          label.className = 'checkbox-label';
          label.innerHTML = `<input type="checkbox" value="${person.id}" checked /><span>${person.name}</span>`;
          billParticipantsDiv.appendChild(label);
        });
      }

      billSection.classList.remove('hidden');
      baseCurrencySelect.value = baseCurrency;

      renderBills();
      if (bills.length > 0) {
        calculateSection.style.display = 'block';
      }
    }

    // ================== ä¸€èˆ¬åŠŸèƒ½ ==================

    function populateCurrencySelect(selectEl, defaultCode) {
      selectEl.innerHTML = '';
      CURRENCIES.forEach(curr => {
        const option = document.createElement('option');
        option.value = curr.code;
        option.textContent = curr.label;
        selectEl.appendChild(option);
      });
      selectEl.value = defaultCode;
    }

    function generatePeopleInputs() {
      if (people.length > 0) return;
      const count = Math.min(Math.max(2, parseInt(peopleCountInput.value) || 2), MAX_PEOPLE);
      peopleCountInput.value = count;
      peopleInputsDiv.innerHTML = '';
      for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'person-input';
        div.innerHTML = `<div class="person-number">${i}</div><input type="text" id="person${i}" placeholder="äººå“¡ ${i}" value="äººå“¡ ${i}" />`;
        peopleInputsDiv.appendChild(div);
      }
    }

    function confirmPeople() {
      const count = parseInt(peopleCountInput.value);
      let newPeople = [];
      for (let i = 1; i <= count; i++) {
        const name = document.getElementById(`person${i}`).value.trim();
        if (name) newPeople.push({ id: i, name: name });
      }

      if (newPeople.length < 2) {
        alert('è‡³å°‘éœ€è¦ 2 å€‹äººï¼');
        return;
      }

      people = newPeople;
      pushToServer();
      updateUIForExistingProject();
    }

    function addBill() {
      const title = billTitleInput.value.trim();
      const amount = parseFloat(billAmountInput.value);
      const category = billCategorySelect.value;
      const currency = billCurrencySelect.value || baseCurrency;
      const paidBy = parseInt(billPaidBySelect.value);
      const participantCheckboxes = billParticipantsDiv.querySelectorAll('input[type="checkbox"]:checked');
      const participants = Array.from(participantCheckboxes).map(cb => parseInt(cb.value));

      billError.classList.add('hidden');
      if (!title) { billError.textContent = 'è«‹è¼¸å…¥å¸³å–®åç¨±'; billError.classList.remove('hidden'); return; }
      if (isNaN(amount) || amount <= 0) { billError.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'; billError.classList.remove('hidden'); return; }
      if (participants.length === 0) { billError.textContent = 'è«‹é¸æ“‡åƒèˆ‡è€…'; billError.classList.remove('hidden'); return; }

      const bill = {
        id: billIdCounter++,
        title: title,
        amount: amount,
        currency: currency,
        category: category,
        paidBy: paidBy,
        participants: participants
      };

      bills.push(bill);
      pushToServer();

      lastBillCurrency = currency;
      billCurrencySelect.value = currency;
      billTitleInput.value = '';
      billAmountInput.value = '';
      calculateSection.style.display = 'block';

      renderBills();
      
      // è‡ªå‹•èƒŒæ™¯è¨ˆç®—ï¼Œç¢ºä¿æ•¸æ“šæ˜¯æœ€æ–°çš„
      // ä½†ä¸æœƒå¼·åˆ¶æ‰“é–‹è¦–çª—ï¼Œå› ç‚º displayResult å·²ç¶“æ”¹ç‚ºä¸å¼·åˆ¶ç§»é™¤ hidden
      calculate();
    }

    function renderBills() {
      if (bills.length === 0) {
        billsListDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>å°šæœªæ–°å¢ä»»ä½•å¸³å–®</p></div>';
        renderDetails();
        return;
      }

      billsListDiv.innerHTML = '<h3 style="margin-bottom: 15px; color: #2d3748;">å·²æ–°å¢çš„å¸³å–®</h3>';

      bills.forEach(bill => {
        const payer = people.find(p => p.id === bill.paidBy) || { name: 'æœªçŸ¥' };
        const participantNames = bill.participants.map(id =>
          people.find(p => p.id === id)?.name || ''
        ).filter(n => n !== ''); 

        const categoryLabel = bill.category ? bill.category : 'ç„¡åˆ†é¡';
        const baseAmount = bill.amountBase;
        const perPersonBase = baseAmount ? baseAmount / bill.participants.length : null;

        const billDiv = document.createElement('div');
        billDiv.className = 'bill-item';
        billDiv.innerHTML = `
          <div class="bill-header">
            <div class="bill-title">${bill.title}</div>
            <div class="bill-amount">${bill.currency || baseCurrency} ${bill.amount.toFixed(2)}</div>
          </div>
          <div class="bill-details">
            <div class="bill-detail-item">
              <span class="bill-detail-label">ä»˜æ¬¾äººï¼š</span>${payer.name}
            </div>
            <div class="bill-detail-item">
              <span class="bill-detail-label">æ¯äººï¼ˆ${baseCurrency}ï¼‰ï¼š</span>${perPersonBase ? perPersonBase.toFixed(2) : 'å¾…è¨ˆç®—'}
            </div>
            <div class="bill-detail-item">
              <span class="bill-detail-label">åˆ†é¡ï¼š</span>
              <span class="category-badge">${categoryLabel}</span>
            </div>
            <div class="bill-detail-item">
              <span class="bill-detail-label">æ›ç®—ç‚º ${baseCurrency}ï¼š</span>${baseAmount ? baseAmount.toFixed(2) : 'å¾…è¨ˆç®—'}
            </div>
          </div>
          <div class="bill-detail-item">
            <span class="bill-detail-label">åƒèˆ‡è€…ï¼š</span>
            <div class="participant-tags">
              ${participantNames.map(name => `<span class="participant-tag">${name}</span>`).join('')}
            </div>
          </div>
          <button class="btn-danger" onclick="deleteBill(${bill.id})" style="margin-top: 12px; font-size: 13px; padding: 8px 16px;">
            ğŸ—‘ï¸ åˆªé™¤
          </button>
        `;
        billsListDiv.appendChild(billDiv);
      });

      renderDetails();
    }

    function deleteBill(billId) {
      if (!confirm("ç¢ºå®šåˆªé™¤æ­¤å¸³å–®ï¼Ÿ")) return;

      bills = bills.filter(b => b.id !== billId);
      pushToServer();
      renderBills();

      if (bills.length === 0) {
        calculateSection.style.display = 'none';
        
        // æ²’å¸³å–®æ™‚ï¼Œå¼·åˆ¶é—œé–‰çµæœå€
        isResultVisible = false;
        resultSection.classList.add('hidden');
        detailSectionEl.classList.add('hidden');
        calculateBtn.innerText = "ğŸ§® åˆ†å¸³çµæœ";
        calculateBtn.classList.remove('btn-gray');
        calculateBtn.classList.add('btn-primary');
      } else {
        calculate();
      }
    }

    async function calculate() {
      if (bills.length === 0) return;
      const request = { baseCurrency: baseCurrency, people: people, bills: bills };

      try {
        let resultJSON;
        if (window.calculateSplit) {
          resultJSON = await window.calculateSplit(JSON.stringify(request));
        } else {
          const response = await fetch('/api/calculate', {
            method: 'POST',
            body: JSON.stringify(request)
          });
          resultJSON = await response.text();
        }

        const result = JSON.parse(resultJSON);
        if (result.error) { alert(result.error); return; }

        if (result.baseCurrency && result.baseCurrency !== baseCurrency) {
          baseCurrency = result.baseCurrency;
          pushToServer();
        }

        if (Array.isArray(result.bills)) {
          const mapById = new Map(result.bills.map(b => [b.id, b]));
          bills.forEach(b => {
            const calc = mapById.get(b.id);
            if (calc) b.amountBase = calc.amountBase;
          });
          renderDetails();
        }

        displayResult(result.settlements);
      } catch (e) {
        alert(e.message);
      }
    }

    function displayResult(settlements) {
      // â˜…â˜…â˜… ä¿®æ­£ï¼šé€™è£¡ä¸å†å¼·åˆ¶ç§»é™¤ hidden class â˜…â˜…â˜…
      // é¡¯ç¤ºèˆ‡å¦å®Œå…¨ç”±æŒ‰éˆ•æ§åˆ¶

      if (settlements.length === 0) {
        resultContent.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âœ…</div><p>å¤ªå¥½äº†ï¼å¤§å®¶å·²ç¶“çµæ¸…ï¼Œä¸éœ€è¦è½‰å¸³</p></div>';
        return;
      }

      let html = '<div style="margin-bottom: 20px;">';
      settlements.forEach((settlement) => {
        html += `
          <div class="settlement-item">
            <div class="settlement-text">
              <span class="settlement-from">${settlement.from}</span>
              éœ€è¦ä»˜çµ¦
              <span class="settlement-to">${settlement.to}</span>
            </div>
            <div class="settlement-amount">$${settlement.amount.toFixed(2)}</div>
          </div>
        `;
      });
      html += '</div>';

      resultContent.innerHTML = html;
    }

    // â˜…â˜…â˜… æ–°å¢ï¼šåˆ‡æ›çµæœé¡¯ç¤ºé‚è¼¯ â˜…â˜…â˜…
    function toggleResults() {
      if (isResultVisible) {
        // ç›®å‰æ˜¯é¡¯ç¤ºç‹€æ…‹ -> åŸ·è¡Œé—œé–‰
        resultSection.classList.add('hidden');
        detailSectionEl.classList.add('hidden');
        
        // æ¢å¾©æŒ‰éˆ•æ¨£å¼
        calculateBtn.innerText = "ğŸ§® åˆ†å¸³çµæœ";
        calculateBtn.classList.remove('btn-gray');
        calculateBtn.classList.add('btn-primary');
        
        isResultVisible = false;
      } else {
        // ç›®å‰æ˜¯éš±è—ç‹€æ…‹ -> åŸ·è¡Œé–‹å•Ÿ
        calculate(); // ç¢ºä¿è³‡æ–™æœ€æ–°
        resultSection.classList.remove('hidden');
        detailSectionEl.classList.remove('hidden');
        
        // æ›´æ”¹æŒ‰éˆ•æ¨£å¼
        calculateBtn.innerText = "âŒ é—œé–‰åˆ†å¸³çµæœ";
        calculateBtn.classList.remove('btn-primary');
        calculateBtn.classList.add('btn-gray');
        
        // æ»¾å‹•åˆ°çµæœå€
        resultSection.scrollIntoView({ behavior: 'smooth' });
        
        isResultVisible = true;
      }
    }

    function reset() {
      people = [];
      bills = [];
      billIdCounter = 1;
      baseCurrency = 'TWD';
      resetUI();
      pushToServer(); 
      closeResetModal();
    }

    function resetUI() {
      billSection.classList.add('hidden');
      resultSection.classList.add('hidden');
      detailSectionEl.classList.add('hidden');
      calculateSection.style.display = 'none';
      billsListDiv.innerHTML = '';
      detailContentEl.innerHTML = '';

      // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
      isResultVisible = false;
      calculateBtn.innerText = "ğŸ§® åˆ†å¸³çµæœ";
      calculateBtn.classList.remove('btn-gray');
      calculateBtn.classList.add('btn-primary');

      peopleCountInput.disabled = false;
      confirmPeopleBtn.disabled = false;
      confirmPeopleBtn.innerText = "âœ“ ç¢ºèªäººå“¡";
      peopleInputsDiv.innerHTML = '';
      generatePeopleInputs();
    }

    function renderDetails() {
      if (!detailContentEl) return;

      if (bills.length === 0) {
        detailContentEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“„</div><p>ç›®å‰æ²’æœ‰æ˜ç´°</p></div>';
        return;
      }

      let html = '';
      bills.forEach(bill => {
        const payer = people.find(p => p.id === bill.paidBy) || { name: 'æœªçŸ¥' };
        const baseAmount = bill.amountBase;
        const perPerson = baseAmount ? baseAmount / bill.participants.length : null;
        const participantNames = bill.participants.map(id => people.find(p => p.id === id)?.name || '').join('ã€');

        html += `
          <div class="detail-card">
            <div class="detail-header">
              <div>${bill.title}</div>
              <div style="color:#667eea;font-weight:700;">${bill.currency || baseCurrency} ${bill.amount.toFixed(2)}</div>
            </div>
            <div class="detail-meta">
              <div>åˆ†é¡ï¼š${bill.category || 'ç„¡åˆ†é¡'}</div>
              <div>ä»˜æ¬¾äººï¼š${payer.name}</div>
              <div>æ›ç®—ç‚º ${baseCurrency}ï¼š${baseAmount ? baseAmount.toFixed(2) : 'å¾…è¨ˆç®—'}</div>
              <div>æ¯äººï¼ˆ${baseCurrency}ï¼‰ï¼š${perPerson ? perPerson.toFixed(2) : 'å¾…è¨ˆç®—'}</div>
            </div>
            <div class="detail-participants">åƒèˆ‡è€…ï¼š${participantNames}</div>
          </div>
        `;
      });

      detailContentEl.innerHTML = html;
    }

    // äº‹ä»¶ç›£è½
    peopleCountInput.addEventListener('input', generatePeopleInputs);
    confirmPeopleBtn.addEventListener('click', confirmPeople);
    addBillBtn.addEventListener('click', addBill);
    
    // â˜…â˜…â˜… ä¿®æ”¹ï¼šæŒ‰éˆ•é»æ“Šæ”¹ç‚ºè§¸ç™¼åˆ‡æ›å‡½å¼ â˜…â˜…â˜…
    calculateBtn.addEventListener('click', toggleResults);

    // Modal
    function openResetModal() { resetModal.classList.remove('hidden'); }
    function closeResetModal() { resetModal.classList.add('hidden'); }
    resetBtn.addEventListener('click', openResetModal);
    cancelResetBtn.addEventListener('click', closeResetModal);
    confirmResetBtn.addEventListener('click', reset);

    baseCurrencySelect.addEventListener('change', () => {
      baseCurrency = baseCurrencySelect.value;
      pushToServer();
    });

    window.deleteBill = deleteBill;
  </script>
</body>

</html>
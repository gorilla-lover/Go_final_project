<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>åˆ†å¸³å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      overflow-y: auto;
    }

    .container {
      max-width: 850px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e9ecef;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      font-size: 14px;
      font-weight: 700;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .people-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .person-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .person-number {
      width: 32px;
      height: 32px;
      background: #667eea;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
    }

    .person-input input {
      flex: 1;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-secondary {
      background: #e9ecef;
      color: #495057;
    }

    .btn-secondary:hover {
      background: #dee2e6;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover {
      background: #e53e3e;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .bill-item {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .bill-item:hover {
      border-color: #cbd5e0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .bill-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }

    .bill-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
    }

    .bill-amount {
      font-size: 18px;
      font-weight: 700;
      color: #667eea;
    }

    .bill-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .bill-detail-item {
      font-size: 13px;
      color: #718096;
    }

    .bill-detail-label {
      font-weight: 600;
      color: #4a5568;
    }

    .participant-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .participant-tag {
      background: #edf2f7;
      color: #4a5568;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .category-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e0f2fe;
      color: #0369a1;
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 12px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .checkbox-label:hover {
      background: #f7fafc;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .result-section {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      padding: 25px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .settlement-item {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .settlement-text {
      font-size: 15px;
      color: #2d3748;
    }

    .settlement-from {
      font-weight: 700;
      color: #667eea;
    }

    .settlement-to {
      font-weight: 700;
      color: #764ba2;
    }

    .settlement-amount {
      font-size: 20px;
      font-weight: 700;
      color: #48bb78;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .hidden {
      display: none;
    }

    .error-message {
      background: #fed7d7;
      color: #c53030;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
    }

    .helper-text {
      font-size: 12px;
      color: #718096;
      margin-top: 6px;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 50;
    }

    .modal {
      background: white;
      border-radius: 14px;
      padding: 20px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
    }

    .modal h3 {
      margin-bottom: 10px;
      font-size: 18px;
      color: #2d3748;
    }

    .modal p {
      color: #4a5568;
      font-size: 14px;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ç¢ºä¿å½ˆçª—éš±è—æ™‚ä¸é¡¯ç¤º */
    .modal-overlay.hidden {
      display: none;
    }

    .detail-section {
      background: #f8fafc;
      border: 2px dashed #cbd5e0;
    }

    .detail-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: 700;
      color: #2d3748;
    }

    .detail-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      font-size: 13px;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .detail-participants {
      font-size: 13px;
      color: #4a5568;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’° åˆ†å¸³å™¨</h1>
      <p>è¼•é¬†ç®¡ç†åœ˜é«”å¸³å‹™ï¼Œä¸€éµè¨ˆç®—èª°è©²ä»˜èª°å¤šå°‘éŒ¢</p>
    </div>

    <div class="content">
      <!-- æ­¥é©Ÿ 1: è¨­å®šäººå“¡ -->
      <div class="section">
        <div class="section-title">
          <span class="step-number">1</span>
          è¨­å®šåƒèˆ‡äººå“¡
        </div>
        <div class="form-group">
          <label>åƒèˆ‡äººæ•¸ï¼ˆæœ€å¤š 20 äººï¼‰</label>
          <input type="number" id="peopleCount" min="2" max="20" value="3" />
        </div>
        <div class="form-group">
          <label>é è¨­å¹£åˆ¥</label>
          <select id="baseCurrency"></select>
          <div id="rateInfo" class="helper-text">ä½¿ç”¨æœ€æ–°åŒ¯ç‡ä¸­â€¦</div>
        </div>
        <div id="peopleInputs" class="people-grid"></div>
        <div class="button-group">
          <button class="btn-primary" id="confirmPeople">
            âœ“ ç¢ºèªäººå“¡
          </button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 2: æ–°å¢å¸³å–® -->
      <div class="section hidden" id="billSection">
        <div class="section-title">
          <span class="step-number">2</span>
          æ–°å¢å¸³å–®
        </div>
        
        <div class="form-group">
          <label>å¸³å–®åç¨±</label>
          <input type="text" id="billTitle" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€è¨ˆç¨‹è»Šã€é›»å½±ç¥¨" />
        </div>

        <div class="form-group">
          <label>åˆ†é¡ï¼ˆå¯é¸ï¼‰</label>
          <select id="billCategory">
            <option value="">ç„¡åˆ†é¡</option>
            <option value="äº¤é€š">äº¤é€š</option>
            <option value="é£²é£Ÿ">é£²é£Ÿ</option>
            <option value="ä½å®¿">ä½å®¿</option>
            <option value="å¨›æ¨‚">å¨›æ¨‚</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label>å¹£åˆ¥</label>
          <select id="billCurrency"></select>
        </div>

        <div class="form-group">
          <label>é‡‘é¡</label>
          <input type="number" id="billAmount" step="0.01" min="0" placeholder="0.00" />
        </div>

        <div class="form-group">
          <label>ç”±èª°å…ˆä»˜æ¬¾</label>
          <select id="billPaidBy"></select>
        </div>

        <div class="form-group">
          <label>åƒèˆ‡åˆ†å¸³çš„äººï¼ˆå¯å¤šé¸ï¼‰</label>
          <div id="billParticipants" class="checkbox-group"></div>
        </div>

        <div class="button-group">
          <button class="btn-success" id="addBill">
            â• æ–°å¢æ­¤å¸³å–®
          </button>
        </div>

        <div id="billError" class="error-message hidden"></div>

        <!-- å·²æ–°å¢çš„å¸³å–®åˆ—è¡¨ -->
        <div id="billsList" style="margin-top: 30px;"></div>

        <div class="button-group" id="calculateSection" style="display: none;">
          <button class="btn-primary" id="calculateBtn">
            ğŸ§® è¨ˆç®—åˆ†å¸³çµæœ
          </button>
        </div>
      </div>

      <!-- æ­¥é©Ÿ 3: çµç®—çµæœ -->
      <div class="section hidden" id="resultSection">
        <div class="section-title">
          <span class="step-number">3</span>
          çµç®—çµæœ
        </div>
        <div id="resultContent"></div>
      </div>

      <!-- æ­¥é©Ÿ 4: æŸ¥çœ‹æ˜ç´° -->
      <div class="section hidden detail-section" id="detailSection">
        <div class="section-title">
          <span class="step-number">4</span>
          æŸ¥çœ‹æ˜ç´°
        </div>
        <div class="helper-text" style="margin-bottom: 12px;">é¡¯ç¤ºæ¯ç­†æ”¯å‡ºåŸå¹£ã€æ›ç®—é‡‘é¡èˆ‡åˆ†æ”¤ç´°ç¯€</div>
        <div id="detailContent"></div>
        <div class="button-group" style="justify-content: flex-end;">
          <button class="btn-secondary" id="resetBtn">
            ğŸ”„ é‡æ–°é–‹å§‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- é‡ç½®ç¢ºèªå½ˆçª— -->
  <div class="modal-overlay hidden" id="resetModal">
    <div class="modal">
      <h3>é‡æ–°é–‹å§‹</h3>
      <p>ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿç›®å‰å¡«å¯«çš„è³‡æ–™éƒ½æœƒæ¸…é™¤ã€‚</p>
      <div class="modal-actions">
        <button class="btn-secondary" id="cancelResetBtn">å–æ¶ˆ</button>
        <button class="btn-danger" id="confirmResetBtn">ç¢ºèªæ¸…é™¤</button>
      </div>
    </div>
  </div>

  <script>
    const MAX_PEOPLE = 20;
    const CURRENCIES = [
      { code: 'TWD', label: 'æ–°å°å¹£ (TWD)' },
      { code: 'USD', label: 'ç¾é‡‘ (USD)' },
      { code: 'EUR', label: 'æ­å…ƒ (EUR)' },
      { code: 'JPY', label: 'æ—¥åœ“ (JPY)' },
      { code: 'KRW', label: 'éŸ“å…ƒ (KRW)' },
      { code: 'HKD', label: 'æ¸¯å¹£ (HKD)' },
      { code: 'CNY', label: 'äººæ°‘å¹£ (CNY)' },
      { code: 'GBP', label: 'è‹±éŠ (GBP)' },
      { code: 'THB', label: 'æ³°éŠ– (THB)' },
    ];
    let baseCurrency = 'TWD';
    let lastBillCurrency = baseCurrency;
    let rates = {}; // ä»¥ baseCurrency ç‚ºåŸºæº–çš„åŒ¯ç‡
    let rateDate = '';
    let people = [];
    let bills = [];
    let billIdCounter = 1;

    // DOM å…ƒç´ 
    const peopleCountInput = document.getElementById('peopleCount');
    const peopleInputsDiv = document.getElementById('peopleInputs');
    const confirmPeopleBtn = document.getElementById('confirmPeople');
    const billSection = document.getElementById('billSection');
    const billTitleInput = document.getElementById('billTitle');
    const billCategorySelect = document.getElementById('billCategory');
    const baseCurrencySelect = document.getElementById('baseCurrency');
    const billCurrencySelect = document.getElementById('billCurrency');
    const rateInfo = document.getElementById('rateInfo');
    const billAmountInput = document.getElementById('billAmount');
    const billPaidBySelect = document.getElementById('billPaidBy');
    const billParticipantsDiv = document.getElementById('billParticipants');
    const addBillBtn = document.getElementById('addBill');
    const billsListDiv = document.getElementById('billsList');
    const calculateSection = document.getElementById('calculateSection');
    const calculateBtn = document.getElementById('calculateBtn');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const resetBtn = document.getElementById('resetBtn');
    const billError = document.getElementById('billError');
    const resetModal = document.getElementById('resetModal');
    const cancelResetBtn = document.getElementById('cancelResetBtn');
    const confirmResetBtn = document.getElementById('confirmResetBtn');
    let detailSectionEl;
    let detailContentEl;

    // å¹£åˆ¥é¸å–®åˆå§‹åŒ–
    function populateCurrencySelect(selectEl, defaultCode) {
      selectEl.innerHTML = '';
      CURRENCIES.forEach(curr => {
        const option = document.createElement('option');
        option.value = curr.code;
        option.textContent = curr.label;
        selectEl.appendChild(option);
      });
      selectEl.value = defaultCode;
    }

    function convertToBase(amount, currency) {
      if (currency === baseCurrency) return amount;
      const rate = rates[currency.toLowerCase()];
      if (!rate) return null; // ç„¡åŒ¯ç‡è³‡æ–™
      return amount / rate;
    }

    function recomputeBillBaseAmounts() {
      bills = bills.map(bill => {
        const converted = convertToBase(bill.amount, bill.currency);
        return { ...bill, amountBase: converted === null ? bill.amountBase : converted };
      });
      renderBills();
      renderDetails();
    }

    async function fetchRates() {
      const base = baseCurrency.toLowerCase();
      rateInfo.textContent = 'åŒ¯ç‡è¼‰å…¥ä¸­â€¦';
      rates = {};
      try {
        const res = await fetch(`https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${base}.json`);
        if (!res.ok) throw new Error('åŒ¯ç‡è®€å–å¤±æ•—');
        const data = await res.json();
        rates = data[base] || {};
        rateDate = data.date || '';
        rateInfo.textContent = `åŸºæº–å¹£åˆ¥ï¼š${baseCurrency}ï¼›æ›´æ–°æ–¼ ${rateDate || 'æœ€æ–°'}`;
        recomputeBillBaseAmounts();
      } catch (err) {
        rateInfo.textContent = `åŒ¯ç‡è®€å–å¤±æ•—ï¼Œåƒ…èƒ½ä½¿ç”¨ ${baseCurrency}ï¼ˆè«‹æª¢æŸ¥ç¶²è·¯ï¼‰`;
        rates = {};
        recomputeBillBaseAmounts();
      }
    }

    // ç”Ÿæˆäººå“¡è¼¸å…¥æ¡†
    function generatePeopleInputs() {
      const count = Math.min(Math.max(2, parseInt(peopleCountInput.value) || 2), MAX_PEOPLE);
      peopleCountInput.value = count;
      
      peopleInputsDiv.innerHTML = '';
      for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'person-input';
        div.innerHTML = `
          <div class="person-number">${i}</div>
          <input type="text" id="person${i}" placeholder="äººå“¡ ${i} çš„åç¨±" value="äººå“¡ ${i}" />
        `;
        peopleInputsDiv.appendChild(div);
      }
    }

    // ç¢ºèªäººå“¡
    function confirmPeople() {
      const count = parseInt(peopleCountInput.value);
      people = [];
      
      for (let i = 1; i <= count; i++) {
        const name = document.getElementById(`person${i}`).value.trim();
        if (name) {
          people.push({ id: i, name: name });
        }
      }

      if (people.length < 2) {
        alert('è‡³å°‘éœ€è¦ 2 å€‹äººï¼');
        return;
      }

      // æ›´æ–°ä»˜æ¬¾äººä¸‹æ‹‰é¸å–®
      billPaidBySelect.innerHTML = '';
      people.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name;
        billPaidBySelect.appendChild(option);
      });

      // æ›´æ–°åƒèˆ‡è€…è¤‡é¸æ¡†
      billParticipantsDiv.innerHTML = '';
      people.forEach(person => {
        const label = document.createElement('label');
        label.className = 'checkbox-label';
        label.innerHTML = `
          <input type="checkbox" value="${person.id}" checked />
          <span>${person.name}</span>
        `;
        billParticipantsDiv.appendChild(label);
      });

      // é¡¯ç¤ºå¸³å–®å€åŸŸ
      billSection.classList.remove('hidden');
      
      // ç¦ç”¨äººå“¡ç·¨è¼¯
      peopleCountInput.disabled = true;
      people.forEach((person, index) => {
        document.getElementById(`person${index + 1}`).disabled = true;
      });
      confirmPeopleBtn.disabled = true;
    }

    // æ–°å¢å¸³å–®
    function addBill() {
      const title = billTitleInput.value.trim();
      const amount = parseFloat(billAmountInput.value);
      const category = billCategorySelect.value;
      const currency = billCurrencySelect.value || baseCurrency;
      const paidBy = parseInt(billPaidBySelect.value);
      
      const participantCheckboxes = billParticipantsDiv.querySelectorAll('input[type="checkbox"]:checked');
      const participants = Array.from(participantCheckboxes).map(cb => parseInt(cb.value));

      // é©—è­‰
      billError.classList.add('hidden');
      
      if (!title) {
        billError.textContent = 'è«‹è¼¸å…¥å¸³å–®åç¨±';
        billError.classList.remove('hidden');
        return;
      }
      
      if (isNaN(amount) || amount <= 0) {
        billError.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡';
        billError.classList.remove('hidden');
        return;
      }
      
      if (participants.length === 0) {
        billError.textContent = 'è«‹è‡³å°‘é¸æ“‡ä¸€ä½åƒèˆ‡è€…';
        billError.classList.remove('hidden');
        return;
      }
      
      const amountBase = convertToBase(amount, currency);
      if (amountBase === null) {
        billError.textContent = 'ç¼ºå°‘è©²å¹£åˆ¥çš„åŒ¯ç‡ï¼Œè«‹å…ˆæ›´æ–°åŒ¯ç‡æˆ–æ”¹ç”¨åŸºæº–å¹£åˆ¥';
        billError.classList.remove('hidden');
        return;
      }

      // æ–°å¢å¸³å–®
      const bill = {
        id: billIdCounter++,
        title: title,
        amount: amount,
        amountBase: amountBase,
        currency: currency,
        category: category,
        paidBy: paidBy,
        participants: participants
      };
      
      bills.push(bill);
      renderBills();
      lastBillCurrency = currency;
      billCurrencySelect.value = currency;
      
      // æ¸…ç©ºè¡¨å–®
      billTitleInput.value = '';
      billAmountInput.value = '';
      
      // é¡¯ç¤ºè¨ˆç®—æŒ‰éˆ•
      calculateSection.style.display = 'block';
    }

    // æ¸²æŸ“å¸³å–®åˆ—è¡¨
    function renderBills() {
      if (bills.length === 0) {
        billsListDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>å°šæœªæ–°å¢ä»»ä½•å¸³å–®</p></div>';
        renderDetails();
        return;
      }

      billsListDiv.innerHTML = '<h3 style="margin-bottom: 15px; color: #2d3748;">å·²æ–°å¢çš„å¸³å–®</h3>';
      
      bills.forEach(bill => {
        const payer = people.find(p => p.id === bill.paidBy);
        const participantNames = bill.participants.map(id => 
          people.find(p => p.id === id)?.name || ''
        );
        const categoryLabel = bill.category ? bill.category : 'ç„¡åˆ†é¡';
        const baseAmount = bill.amountBase ?? bill.amount;
        const perPersonBase = baseAmount / bill.participants.length;

        const billDiv = document.createElement('div');
        billDiv.className = 'bill-item';
        billDiv.innerHTML = `
          <div class="bill-header">
            <div class="bill-title">${bill.title}</div>
            <div class="bill-amount">${bill.currency || baseCurrency} ${bill.amount.toFixed(2)}</div>
          </div>
          <div class="bill-details">
            <div class="bill-detail-item">
              <span class="bill-detail-label">ä»˜æ¬¾äººï¼š</span>${payer.name}
            </div>
            <div class="bill-detail-item">
              <span class="bill-detail-label">æ¯äººï¼ˆ${baseCurrency}ï¼‰ï¼š</span>${perPersonBase.toFixed(2)}
            </div>
            <div class="bill-detail-item">
              <span class="bill-detail-label">åˆ†é¡ï¼š</span>
              <span class="category-badge">${categoryLabel}</span>
            </div>
            <div class="bill-detail-item">
              <span class="bill-detail-label">æ›ç®—ç‚º ${baseCurrency}ï¼š</span>${bill.amountBase.toFixed(2)}
            </div>
          </div>
          <div class="bill-detail-item">
            <span class="bill-detail-label">åƒèˆ‡è€…ï¼š</span>
            <div class="participant-tags">
              ${participantNames.map(name => `<span class="participant-tag">${name}</span>`).join('')}
            </div>
          </div>
          <button class="btn-danger" onclick="deleteBill(${bill.id})" style="margin-top: 12px; font-size: 13px; padding: 8px 16px;">
            ğŸ—‘ï¸ åˆªé™¤
          </button>
        `;
        billsListDiv.appendChild(billDiv);
      });

      renderDetails();
    }

    // åˆªé™¤å¸³å–®
    function deleteBill(billId) {
      bills = bills.filter(b => b.id !== billId);
      renderBills();
      
      if (bills.length === 0) {
        calculateSection.style.display = 'none';
      }
      renderDetails();
    }

    // è¨ˆç®—åˆ†å¸³
    async function calculate() {
      if (bills.length === 0) {
        alert('è«‹å…ˆæ–°å¢è‡³å°‘ä¸€ç­†å¸³å–®ï¼');
        return;
      }

      try {
        const payloadBills = bills.map(bill => {
          if (bill.amountBase === null || bill.amountBase === undefined) {
            throw new Error(`ç¼ºå°‘ ${bill.currency} å° ${baseCurrency} çš„åŒ¯ç‡ï¼Œç„¡æ³•è¨ˆç®—`);
          }
          return {
            id: bill.id,
            title: bill.title,
            amount: bill.amountBase,
            category: bill.category,
            currency: bill.currency,
            paidBy: bill.paidBy,
            participants: bill.participants
          };
        });

        const request = {
          people: people,
          bills: payloadBills
        };

        const resultJSON = await window.calculateSplit(JSON.stringify(request));
        const result = JSON.parse(resultJSON);

        if (result.error) {
          alert('è¨ˆç®—éŒ¯èª¤ï¼š' + result.error);
          return;
        }

        displayResult(result.settlements);
      } catch (error) {
        alert('è¨ˆç®—ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
      }
      renderDetails();
    }

    // é¡¯ç¤ºçµæœ
    function displayResult(settlements) {
      resultSection.classList.remove('hidden');
      detailSectionEl.classList.remove('hidden');
      
      if (settlements.length === 0) {
        resultContent.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âœ…</div><p>å¤ªå¥½äº†ï¼å¤§å®¶å·²ç¶“çµæ¸…ï¼Œä¸éœ€è¦è½‰å¸³</p></div>';
        return;
      }

      let html = '<div style="margin-bottom: 20px;">';
      settlements.forEach((settlement, index) => {
        html += `
          <div class="settlement-item">
            <div class="settlement-text">
              <span class="settlement-from">${settlement.from}</span>
              éœ€è¦ä»˜çµ¦
              <span class="settlement-to">${settlement.to}</span>
            </div>
            <div class="settlement-amount">$${settlement.amount.toFixed(2)}</div>
          </div>
        `;
      });
      html += '</div>';
      
      resultContent.innerHTML = html;
      
      // æ»¾å‹•åˆ°çµæœ
      resultSection.scrollIntoView({ behavior: 'smooth' });
    }

    // é‡ç½®
    function reset() {
      people = [];
      bills = [];
      billIdCounter = 1;
      baseCurrency = 'TWD';
      lastBillCurrency = baseCurrency;
      populateCurrencySelect(baseCurrencySelect, baseCurrency);
      populateCurrencySelect(billCurrencySelect, lastBillCurrency);
      fetchRates();
      
      peopleCountInput.disabled = false;
      peopleCountInput.value = 3;
      confirmPeopleBtn.disabled = false;
      
      generatePeopleInputs();
      
      billSection.classList.add('hidden');
      resultSection.classList.add('hidden');
      detailSectionEl.classList.add('hidden');
      calculateSection.style.display = 'none';
      
      billTitleInput.value = '';
      billCategorySelect.value = '';
      billAmountInput.value = '';
      billsListDiv.innerHTML = '';
      billError.classList.add('hidden');
      detailContentEl.innerHTML = '';
      closeResetModal();
    }

    function renderDetails() {
      if (!detailContentEl) return;
      if (bills.length === 0) {
        detailContentEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“„</div><p>ç›®å‰æ²’æœ‰æ˜ç´°</p></div>';
        return;
      }

      let html = '';
      bills.forEach(bill => {
        const payer = people.find(p => p.id === bill.paidBy);
        const baseAmount = bill.amountBase ?? bill.amount;
        const perPerson = baseAmount / bill.participants.length;
        const participantNames = bill.participants.map(id => people.find(p => p.id === id)?.name || '').join('ã€');
        html += `
          <div class="detail-card">
            <div class="detail-header">
              <div>${bill.title}</div>
              <div style="color:#667eea;font-weight:700;">${bill.currency || baseCurrency} ${bill.amount.toFixed(2)}</div>
            </div>
            <div class="detail-meta">
              <div>åˆ†é¡ï¼š${bill.category || 'ç„¡åˆ†é¡'}</div>
              <div>ä»˜æ¬¾äººï¼š${payer ? payer.name : 'æœªçŸ¥'}</div>
              <div>æ›ç®—ç‚º ${baseCurrency}ï¼š${baseAmount.toFixed(2)}</div>
              <div>æ¯äººï¼ˆ${baseCurrency}ï¼‰ï¼š${perPerson.toFixed(2)}</div>
            </div>
            <div class="detail-participants">åƒèˆ‡è€…ï¼š${participantNames}</div>
          </div>
        `;
      });

      detailContentEl.innerHTML = html;
    }

    // äº‹ä»¶ç›£è½
    peopleCountInput.addEventListener('input', generatePeopleInputs);
    confirmPeopleBtn.addEventListener('click', confirmPeople);
    addBillBtn.addEventListener('click', addBill);
    calculateBtn.addEventListener('click', calculate);
    function openResetModal() {
      if (!resetModal) return;
      resetModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeResetModal() {
      if (!resetModal) return;
      resetModal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    resetBtn.addEventListener('click', openResetModal);
    cancelResetBtn.addEventListener('click', closeResetModal);
    resetModal.addEventListener('click', (e) => {
      if (e.target === resetModal) closeResetModal();
    });
    confirmResetBtn.addEventListener('click', () => {
      closeResetModal();
      reset();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeResetModal();
    });
    baseCurrencySelect.addEventListener('change', () => {
      baseCurrency = baseCurrencySelect.value;
      lastBillCurrency = baseCurrency;
      billCurrencySelect.value = lastBillCurrency;
      fetchRates();
    });

    // åˆå§‹åŒ–
    detailSectionEl = document.getElementById('detailSection');
    detailContentEl = document.getElementById('detailContent');
    populateCurrencySelect(baseCurrencySelect, baseCurrency);
    populateCurrencySelect(billCurrencySelect, lastBillCurrency);
    fetchRates();
    generatePeopleInputs();

    // å…¨åŸŸå‡½å¼ä¾› inline onclick ä½¿ç”¨
    window.deleteBill = deleteBill;
  </script>
</body>
</html>
